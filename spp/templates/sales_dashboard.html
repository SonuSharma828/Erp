
{% extends 'base.html' %}
{% block title %}Sales Dashboard{% endblock %}

{% load custom_filters %}
{% block navcontent %}
 {% load custom_filters %}
            {% if request.user.is_authenticated %}
  {% if request.user.is_superuser %}
    {% include 'dashboard/admin.html' %}
  {% elif request.user.department %}
    {% if request.user.department.department_name|strip_lower == "finance" %}
      {% include 'dashboard/finance.html' %}
    {% endif %}
  {% endif %}
{% endif %}
{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-4">Sales Dashboard</h1>
<a href="{% url 'spp_dashboard' %}" class="inline-block mb-4 bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300 shadow">
    ← Back to Financial Dashboard
</a>

<div class="flex justify-end mb-4">
    <label class="mr-2">Filter:</label>
    <select id="salesFilter" onchange="loadSalesChart()" class="border px-2 py-1 rounded">
        <option value="daily">Daily</option>
        <option value="monthly" selected>Monthly</option>
        <option value="yearly">Yearly</option>
    </select>
</div>

<div class="bg-white p-4 rounded shadow">
    <canvas id="salesChart" class="w-full h-96"></canvas>
</div>

<div class="flex space-x-4 mt-6">
    <button onclick="window.print()" class="bg-blue-600 text-white px-4 py-2 rounded-xl shadow hover:bg-blue-700">
        Export PDF
    </button>
    <a href="{% url 'export_sales_csv' %}" class="bg-green-600 text-white px-4 py-2 rounded-xl shadow hover:bg-green-700">
        Export CSV
    </a>
</div>


<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
    <!-- Product Breakdown -->
    <div class="bg-white p-4 rounded-xl shadow">
        <h3 class="font-semibold text-lg mb-2">Sales by Product</h3>
        <ul>
            {% for p in products %}
            <li class="flex justify-between text-sm border-b py-1">
                <span>{{ p.product__name }}</span>
                <span>₹ {{ p.total|floatformat:2 }}</span>
            </li>
            {% empty %}
            <li>No sales</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Company Breakdown -->
    <div class="bg-white p-4 rounded-xl shadow">
        <h3 class="font-semibold text-lg mb-2">Sales by Company</h3>
        <ul>
            {% for c in companies %}
            <li class="flex justify-between text-sm border-b py-1">
                <span>{{ c.company__name }}</span>
                <span>₹ {{ c.total|floatformat:2 }}</span>
            </li>
            {% empty %}
            <li>No sales</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Payment Status -->
    <div class="bg-white p-4 rounded-xl shadow">
        <h3 class="font-semibold text-lg mb-2">Payment Status</h3>
        <ul>
            <li class="flex justify-between text-sm border-b py-1">
                <span>Settled</span>
                <span>{{ payment_status.Settled }}</span>
            </li>
            <li class="flex justify-between text-sm border-b py-1">
                <span>Pending</span>
                <span>{{ payment_status.Pending }}</span>
            </li>
            <li class="flex justify-between text-sm border-b py-1">
                <span>Overpaid</span>
                <span>{{ payment_status.Overpaid }}</span>
            </li>
        </ul>
    </div>
</div>

{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
Chart.register({
    id: 'noDataPlugin',
    afterDraw: function(chart) {
        if (
            chart.data.datasets.length === 0 ||
            chart.data.datasets[0].data.length === 0 ||
            chart.data.datasets[0].data.every(val => val === 0)
        ) {
            const ctx = chart.ctx;
            const width = chart.width;
            const height = chart.height;

            ctx.save();
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = '16px sans-serif';
            ctx.fillStyle = '#999';
            ctx.fillText('No data available', width / 2, height / 2);
            ctx.restore();
        }
    }
});

let salesChart;

function loadSalesChart() {
    const filter = document.getElementById("salesFilter").value;

    fetch(`/spp/sales-chart-data/?filter=${filter}`)
        .then(res => res.json())
        .then(data => {
            const ctx = document.getElementById("salesChart").getContext("2d");

            if (salesChart) salesChart.destroy();

            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Sales Amount (₹)',
                        data: data.data,
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => `₹ ${value}`
                            }
                        }
                    }
                },
                plugins: ['noDataPlugin']
            });
        });
}

document.addEventListener("DOMContentLoaded", loadSalesChart);
</script>
{% endblock %}


