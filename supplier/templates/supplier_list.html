{% extends 'base.html' %}

{% block title %}Suppliers{% endblock %}

{% block navcontent %}
  {% if request.user.is_authenticated %}
    {% if request.user.is_superuser %}
      {% include 'dashboard/admin.html' %}
    {% elif request.user.department %}
      {% if request.user.department.department_name|lower == "inventory" %}
        {% include 'dashboard/inventory.html' %}
      {% endif %}
    {% endif %}
  {% endif %}
{% endblock %}

{% block content %}
 <div class="max-w-7xl mx-auto py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Vendors List</h1>
        <a href="{% url 'add_supplier' %}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add New Vendor</a>
    </div>

    <!-- Search input -->
    <div class="mb-4">
      <input id="supplierSearchInput" type="text" placeholder="Search Vendors..." class="px-4 py-2 border rounded w-full max-w-sm"/>
    </div>

<div class="overflow-x-auto bg-white shadow-md rounded-lg">

    <table id="supplierTable" class="min-w-full text-left border border-gray-200 text-sm">
      <thead class="bg-gray-200 text-gray-700 uppercase text-xs">
        <tr>
          <th class="border px-4 py-2">Sno.</th>
          <th class="border px-4 py-2">Vendor Name</th>
          <th class="border px-4 py-2">Phone</th>
          <th class="border px-4 py-2">Email</th>
          <th class="border px-4 py-2">Company</th>
          <th class="border px-4 py-2">Contact Person(s)</th>
          <th class="border px-4 py-2">Actions</th>
        </tr>
      </thead>
      <tbody class="text-center">
        {% for supplier in page_obj %}
        <tr class="hover:bg-gray-50">
          <td class="border px-4 py-2">{{ forloop.counter0|add:page_obj.start_index }}</td>
          <td class="border px-4 py-2">{{ supplier.supplier_name|title }}</td>
          <td class="border px-4 py-2">{{ supplier.country_code }} {{ supplier.phone }}</td>
          <td class="border px-4 py-2">{{ supplier.email }}</td>
          <td class="border px-4 py-2">
              {% if supplier.company %}{{ supplier.company.name }}{% else %}N/A{% endif %}
          </td>
          <td class="border px-4 py-2">
            <ul class="list-disc list-inside text-left">
              {% for contact in supplier.contacts.all %}
                <li>{{ contact.name }} ({{ contact.phone }})</li>
              {% empty %}
                <li class="text-gray-400">No contacts</li>
              {% endfor %}
            </ul>
          </td>
          <td class="border px-4 py-2 space-y-1">
            <a href="{% url 'edit_supplier' supplier.pk %}" class="inline-block bg-blue-500 text-white text-xs px-3 py-1 rounded hover:bg-blue-600">Edit</a>
            <a href="{% url 'delete_supplier' supplier.pk %}" class="inline-block bg-red-500 text-white text-xs px-3 py-1 rounded hover:bg-red-600" onclick="return confirm('Are you sure you want to delete this supplier?')">Delete</a>
            <a href="{% url 'show_bill_details' supplier.pk %}" class="inline-block bg-gray-700 text-white text-xs px-3 py-1 rounded hover:bg-gray-800">Show Bill Details</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
</div>
<div class="mt-6 flex justify-center flex-wrap gap-2">
  {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}"
       class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
       Previous
    </a>
  {% endif %}

  {% for num in page_obj.paginator.page_range %}
    {% if page_obj.number == num %}
      <span class="px-4 py-2 bg-blue-600 text-white rounded">{{ num }}</span>
    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
      <a href="?page={{ num }}" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">{{ num }}</a>
    {% endif %}
  {% endfor %}

  {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}"
       class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
       Next
    </a>
  {% endif %}
</div>
</div>

<!-- Search filter script -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('supplierSearchInput');
    const table = document.getElementById('supplierTable');
    const rows = table.querySelectorAll('tbody tr');

    searchInput.addEventListener('input', function () {
      const filter = this.value.toLowerCase();

      rows.forEach(row => {
        // Check all td columns except last (actions)
        const columns = Array.from(row.querySelectorAll('td'));
        // Exclude last column for actions
        const columnsToCheck = columns.slice(0, columns.length - 1);

        // Combine text from all checked columns
        const rowText = columnsToCheck.map(td => td.textContent.toLowerCase()).join(' ');

        if (rowText.includes(filter)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    });
  });
</script>

{% endblock %}

