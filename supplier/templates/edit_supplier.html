{% extends 'base.html' %}
{% block title %}Edit Supplier{% endblock %}
{% load widget_tweaks %}

{% block navcontent %}
  {% if request.user.is_authenticated %}
    {% if request.user.is_superuser %}
      {% include 'dashboard/admin.html' %}
    {% elif request.user.department %}
      {% if request.user.department.department_name|lower == "inventory" %}
        {% include 'dashboard/inventory.html' %}
      {% endif %}
    {% endif %}
  {% endif %}
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto bg-white p-6 rounded shadow">
  <h1 class="text-3xl font-bold mb-6">Edit Vendor</h1>

  <form method="post" enctype="multipart/form-data" action="">
    {% csrf_token %}

    <!-- Supplier Fields -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div><label class="block font-medium mb-1">Vendor Name</label>{{ form.supplier_name }}</div>
      <div><label class="block font-medium mb-1">GST Number</label>{{ form.gst_number }}</div>
      <div><label class="block font-medium mb-1">Address</label>{{ form.address }}</div>
      <div><label class="block font-medium mb-1">Company</label>{{ form.company }}</div>

      <div class="col-span-2">
        <label class="block font-medium mb-1">Phone Number</label>
        <div class="flex">
          <div class="w-1/4">{{ form.country_code|add_class:"block w-full border border-gray-300 rounded-l px-2 py-2" }}</div>
          <div class="w-3/4">{{ form.phone|add_class:"block w-full border border-gray-300 rounded-r px-2 py-2" }}</div>
        </div>
      </div>

      <div><label class="block font-medium mb-1">Email</label>{{ form.email }}</div>
    </div>

    <!-- Contact Persons -->
    <div class="mt-6 border-t pt-4">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">Contact Person(s)</h2>
        <button type="button" onclick="openContactModal()" class="bg-green-600 text-white px-3 py-1 rounded text-sm">+ Add Contact</button>
      </div>
      <input type="hidden" name="contacts-TOTAL_FORMS" id="id_contacts-TOTAL_FORMS" value="{{ contacts|length }}">
      <div id="contact-list" class="space-y-2 mt-4">
        {% for contact in contacts %}
          <div class="border p-2 rounded bg-gray-50 flex justify-between items-center" data-index="{{ forloop.counter0 }}">
            <div>
              <strong>{{ contact.name }}</strong> - {{ contact.phone }}
              <input type="hidden" name="contacts-{{ forloop.counter0 }}-id" value="{{ contact.id }}">
              <input type="hidden" name="contacts-{{ forloop.counter0 }}-name" value="{{ contact.name }}">
              <input type="hidden" name="contacts-{{ forloop.counter0 }}-phone" value="{{ contact.phone }}">
            </div>
            <button type="button" onclick="removeContact(this)" class="text-red-600 font-bold">&times;</button>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Bills -->
    <div class="mt-6 border-t pt-4">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">Bill Details</h2>
        <button type="button" onclick="openBillModal()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">+ Add Bill</button>
      </div>
      <input type="hidden" name="bills-TOTAL_FORMS" id="id_bills-TOTAL_FORMS" value="{{ bills|length }}">
      <div id="bill-list" class="space-y-2 mt-4">
        {% for bill in bills %}
          <div class="border p-2 rounded bg-gray-50 flex justify-between items-center" data-index="{{ forloop.counter0 }}">
            <div>
              <strong>{{ bill.bill_number }}</strong> - ₹{{ bill.amount }} ({{ bill.bill_date }})
              <input type="hidden" name="bills-{{ forloop.counter0 }}-id" value="{{ bill.id }}">
              <input type="hidden" name="bills-{{ forloop.counter0 }}-bill_number" value="{{ bill.bill_number }}">
              <input type="hidden" name="bills-{{ forloop.counter0 }}-bill_date" value="{{ bill.bill_date }}">
              <input type="hidden" name="bills-{{ forloop.counter0 }}-amount" value="{{ bill.amount }}">
              <input type="hidden" name="bills-{{ forloop.counter0 }}-description" value="{{ bill.description }}">
              <!-- You can add a link to view invoice -->
              {% if bill.invoice %}
                <a href="{{ bill.invoice.url }}" target="_blank" class="text-blue-600 underline ml-2">Invoice</a>
              {% endif %}
            </div>
            <button type="button" onclick="removeBill(this)" class="text-red-600 font-bold">&times;</button>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Submit -->
    <div class="mt-6">
      <button type="submit" class="w-full bg-blue-700 hover:bg-blue-800 text-white py-2 px-4 rounded">
        Update
      </button>
    </div>
  </form>

  <a href="{% url 'supplier_list' %}" class="block text-center text-blue-500 mt-4">Back to List</a>
</div>

<!-- Contact Modal (same as add_supplier.html) -->
<div id="contactModal" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded shadow-lg w-full max-w-md p-6">
    <h2 class="text-lg font-semibold mb-4">Add Contact Person</h2>
    <form id="contactForm">
      <div class="mb-3"><label>Name</label><input type="text" id="contactName" class="w-full border px-2 py-1 rounded" required></div>
      <div class="mb-3"><label>Phone</label><input type="text" id="contactPhone" class="w-full border px-2 py-1 rounded" required></div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeContactModal()" class="bg-gray-400 text-white px-3 py-1 rounded">Cancel</button>
        <button type="submit" class="bg-green-600 text-white px-3 py-1 rounded">Add</button>
      </div>
    </form>
  </div>
</div>

<!-- Bill Modal (similar to add_supplier.html but we allow file upload too) -->
<div id="billModal" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded shadow-lg w-full max-w-lg p-6">
    <h2 class="text-lg font-semibold mb-4">Add Bill Detail</h2>
    <form id="billForm" enctype="multipart/form-data">
      <div class="mb-3"><label>Bill Number</label><input type="text" id="billNumber" class="w-full border px-2 py-1 rounded" required></div>
      <div class="mb-3"><label>Date</label><input type="date" id="billDate" class="w-full border px-2 py-1 rounded" required></div>
      <div class="mb-3"><label>Amount</label><input type="number" id="billAmount" class="w-full border px-2 py-1 rounded" required></div>
      <div class="mb-3"><label>Description</label><textarea id="billDescription" class="w-full border px-2 py-1 rounded"></textarea></div>
      <div class="mb-3">
        <label>Invoice File</label>
        <input type="file" id="billInvoice" name="billInvoice" class="w-full border px-2 py-1 rounded">
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeBillModal()" class="bg-gray-400 text-white px-3 py-1 rounded">Cancel</button>
        <button type="submit" class="bg-blue-600 text-white px-3 py-1 rounded">Add</button>
      </div>
    </form>
  </div>
</div>

<script>
  let contactIndex = {{ contacts|length }};
  let billIndex = {{ bills|length }};

  // Contact Modal
  function openContactModal() {
    document.getElementById('contactModal').classList.remove('hidden');
  }

  function closeContactModal() {
    document.getElementById('contactModal').classList.add('hidden');
    document.getElementById('contactForm').reset();
  }

  function removeContact(btn) {
    btn.closest('div[data-index]').remove();
    contactIndex--;
    document.getElementById('id_contacts-TOTAL_FORMS').value = contactIndex;
    reindexContacts();
  }

  function reindexContacts() {
    const contacts = document.querySelectorAll('#contact-list > div[data-index]');
    contacts.forEach((div, idx) => {
      div.setAttribute('data-index', idx);
      div.querySelectorAll('input').forEach(input => {
        const nameParts = input.name.split('-');
        input.name = `contacts-${idx}-${nameParts[2]}`;
      });
    });
  }

  document.getElementById('contactForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const name = document.getElementById('contactName').value;
    const phone = document.getElementById('contactPhone').value;

    const wrapper = document.getElementById('contact-list');
    wrapper.innerHTML += `
      <div class="border p-2 rounded bg-gray-50 flex justify-between items-center" data-index="${contactIndex}">
        <div>
          <strong>${name}</strong> - ${phone}
          <input type="hidden" name="contacts-${contactIndex}-name" value="${name}">
          <input type="hidden" name="contacts-${contactIndex}-phone" value="${phone}">
        </div>
        <button type="button" onclick="removeContact(this)" class="text-red-600 font-bold">&times;</button>
      </div>
    `;

    contactIndex++;
    document.getElementById('id_contacts-TOTAL_FORMS').value = contactIndex;
    closeContactModal();
  });

  // Bill Modal
  function openBillModal() {
    document.getElementById('billModal').classList.remove('hidden');
  }

  function closeBillModal() {
    document.getElementById('billModal').classList.add('hidden');
    document.getElementById('billForm').reset();
  }

  function removeBill(btn) {
    btn.closest('div[data-index]').remove();
    billIndex--;
    document.getElementById('id_bills-TOTAL_FORMS').value = billIndex;
    reindexBills();
  }

  function reindexBills() {
    const bills = document.querySelectorAll('#bill-list > div[data-index]');
    bills.forEach((div, idx) => {
      div.setAttribute('data-index', idx);
      div.querySelectorAll('input').forEach(input => {
        const nameParts = input.name.split('-');
        input.name = `bills-${idx}-${nameParts[2]}`;
      });
    });
  }

  document.getElementById('billForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const number = document.getElementById('billNumber').value;
    const date = document.getElementById('billDate').value;
    const amount = document.getElementById('billAmount').value;
    const desc = document.getElementById('billDescription').value;
    const fileInput = document.getElementById('billInvoice');

    const wrapper = document.getElementById('bill-list');
    wrapper.innerHTML += `
      <div class="border p-2 rounded bg-gray-50 flex justify-between items-center" data-index="${billIndex}">
        <div>
          <strong>${number}</strong> - ₹${amount} (${date})
          <input type="hidden" name="bills-${billIndex}-bill_number" value="${number}">
          <input type="hidden" name="bills-${billIndex}-bill_date" value="${date}">
          <input type="hidden" name="bills-${billIndex}-amount" value="${amount}">
          <input type="hidden" name="bills-${billIndex}-description" value="${desc}">
          <!-- Invoice file input can't be cloned easily, so user must re-upload on edit -->
        </div>
        <button type="button" onclick="removeBill(this)" class="text-red-600 font-bold">&times;</button>
      </div>
    `;

    billIndex++;
    document.getElementById('id_bills-TOTAL_FORMS').value = billIndex;
    closeBillModal();
  });
</script>

{% endblock %}
