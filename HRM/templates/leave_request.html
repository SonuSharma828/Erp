{% extends 'base.html' %}
{% block navcontent %}
      {% if request.user.is_authenticated %}
  {% if request.user.is_superuser %}
    {% include 'dashboard/admin.html' %}
  {% elif request.user.department %}
    {% if request.user.department.department_name|lower == "hr" %}
      {% include 'dashboard/hr.html' %}
    {% endif %}
  {% endif %}
{% endif %}
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-4 mt-6 bg-white shadow rounded">
  <h2 class="text-xl font-bold mb-4">Leave Requests</h2>
  <table class="w-full text-sm border">
    <thead>
      <tr class="bg-gray-200">
        <th>User</th><th>From</th><th>To</th><th>Status</th><th>Actions</th>
      </tr>
    </thead>
    <tbody id="leaveTable"></tbody>
  </table>
</div>

<script>
async function loadLeaves() {
  const res = await fetch("/api/hr/leave-requests/");
  const data = await res.json();

  const tbody = document.getElementById("leaveTable");
  tbody.innerHTML = "";
  data.forEach(leave => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${leave.user}</td>
      <td>${leave.start_date}</td>
      <td>${leave.end_date}</td>
      <td>${leave.status}</td>
      <td>
        ${leave.status === 'pending' ? `
          <button onclick="updateStatus(${leave.id}, 'approved')" class="text-green-600">Approve</button> |
          <button onclick="updateStatus(${leave.id}, 'rejected')" class="text-red-600">Reject</button>
        ` : '-'}
      </td>
    `;
    tbody.appendChild(row);
  });
}

async function updateStatus(id, status) {
  const res = await fetch("/api/hr/leave-requests/", {
    method: "PATCH",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie('csrftoken')
    },
    body: JSON.stringify({ id, status })
  });

  const data = await res.json();
  alert(data.message || "Updated");
  loadLeaves();
}

loadLeaves();
</script>
{% endblock %}

