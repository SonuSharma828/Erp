{% extends 'base.html' %}
{% block navcontent %}
      {% if request.user.is_authenticated %}
  {% if request.user.is_superuser %}
    {% include 'dashboard/admin.html' %}
  {% elif request.user.department %}
    {% if request.user.department.department_name|lower == "hr" %}
      {% include 'dashboard/hr.html' %}
    {% endif %}
  {% endif %}
{% endif %}
{% endblock %}
{% block content %}
<div class="max-w-3xl mx-auto mt-6 bg-white p-4 rounded shadow">
  <h2 class="text-xl font-semibold mb-4">Monthly Leave Report</h2>

  <div class="flex gap-4 mb-4">
    <input type="month" id="monthPicker" class="border p-2 rounded">
    <button onclick="loadReport()" class="bg-blue-600 text-white px-4 py-2 rounded">Generate</button>
    <button onclick="exportCSV()" class="bg-green-600 text-white px-4 py-2 rounded">Export CSV</button>
    <button onclick="window.print()" class="bg-purple-600 text-white px-4 py-2 rounded">Export PDF</button>
  </div>

  <table class="w-full text-sm border" id="reportTable">
    <thead class="bg-gray-200">
      <tr>
        <th>Technician</th>
        <th>Approved</th>
        <th>Pending</th>
        <th>Rejected</th>
      </tr>
    </thead>
    <tbody id="reportBody"></tbody>
  </table>
</div>

<script>
let latestReport = {};

async function loadReport() {
  const month = document.getElementById("monthPicker").value;
  if (!month) {
    alert("Please select a month");
    return;
  }

  const res = await fetch(`/api/hr/leave-report/?month=${month}`);
  const data = await res.json();
  latestReport = data;

  const tbody = document.getElementById("reportBody");
  tbody.innerHTML = "";

  for (const user in data) {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${user}</td>
      <td>${data[user].approved || 0}</td>
      <td>${data[user].pending || 0}</td>
      <td>${data[user].rejected || 0}</td>
    `;
    tbody.appendChild(row);
  }
}

function exportCSV() {
  let csv = "Technician,Approved,Pending,Rejected\n";
  for (const user in latestReport) {
    const rec = latestReport[user];
    csv += `${user},${rec.approved || 0},${rec.pending || 0},${rec.rejected || 0}\n`;
  }

  const blob = new Blob([csv], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "leave_report.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>

{% endblock %}
