{% extends 'base.html' %}
{% load slugify_tags %}
{% block title %}Tasks {% endblock %}
{% block navcontent %}
        {% if request.user.is_authenticated %}
  {% if request.user.is_superuser %}
    {% include 'dashboard/admin.html' %}
  {% elif request.user.department %}
    {% if request.user.department.department_name|lower == "hr" %}
      {% include 'dashboard/hr.html' %}
    {% endif %}
  {% endif %}
{% endif %}
{% endblock %}

{% block content %}

 <div class="max-w-7xl mx-auto py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Task List</h1>
        <a href="{% url 'add_task' %}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add New Task</a>
    </div>

<div class="flex flex-wrap gap-4 mb-4">
    <select id="priorityFilter" class="border p-2 rounded" onchange="filterTasks()">
        <option value="">Priority</option>
        {% for priority in priorities %}
        <option value="{{ priority.name|lower }}">{{ priority.name }}</option>
        {% endfor %}
    </select>

    <select id="assignedToFilter" class="border p-2 rounded" onchange="filterTasks()">
        <option value="">Assigned To</option>
        {% for user in users %}
        <option value="{{ user.username|default:user.username|lower }}">{{ user.username|default:user.username }}</option>
        {% endfor %}
    </select>

    <select id="statusFilter" class="border p-2 rounded" onchange="filterTasks()">
        <option value="">Status</option>
        {% for status in statuses %}
        <option value="{{ status.name|lower|slugify_text }}">{{ status.name }}</option>
        {% endfor %}
    </select>
</div>


<div class="overflow-x-auto bg-white shadow-md rounded-lg">
    <table class="min-w-full text-left border border-gray-200 text-sm">
      <thead class="bg-gray-200">

        <tr class="bg-gray-200">
          <th class="border p-2">S.No</th>
          <th class="border p-2">Task Details</th>
          <th class="border p-2">Priority</th>
          <th class="border p-2">Assigned To</th>
          <th class="border p-2">status</th>
          <th class="border p-2 whitespace-nowrap">Date</th>
          <th class="border p-2">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for task in page_obj %}
        <tr>
          <td class="border p-2">{{ forloop.counter0|add:page_obj.start_index }}</td>
          <td class="border p-2">{{ task.task_detail|title }}</td>
          <td class="border p-2">{{ task.priority|title }}</td>
          <td class="border p-2">{{ task.assigned_to|title }}</td>
          <td class="border p-2">{{ task.status|title }}</td>
          <td class="border p-2 whitespace-nowrap">{{ task.date }}</td>
          <td class="border p-2 whitespace-nowrap ">
            {% if task.sno %}
            <a href="{% url 'edit_task' task.sno %}" class="inline-block bg-blue-500 text-white text-sm px-3 py-1 rounded hover:bg-blue-600">Edit</a>
            <a href="{% url 'delete_task' task.sno %}" class="inline-block bg-red-500 text-white text-sm px-3 py-1 rounded hover:bg-red-600" onclick="return confirm('Are you sure you want to delete this task?');">Delete</a>
            {% else %}
            <span>Not Updateable</span>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9" class="border p-2 text-center">No tasks found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
</div>
<div class="mt-6 flex justify-center flex-wrap gap-2">
  {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}"
       class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
       Previous
    </a>
  {% endif %}

  {% for num in page_obj.paginator.page_range %}
    {% if page_obj.number == num %}
      <span class="px-4 py-2 bg-blue-600 text-white rounded">{{ num }}</span>
    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
      <a href="?page={{ num }}" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">{{ num }}</a>
    {% endif %}
  {% endfor %}

  {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}"
       class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
       Next
    </a>
  {% endif %}
</div>

  



<script>

function slugify(text) {
    return text.toLowerCase().trim().replace(/[_\s]+/g, '-').replace(/[^\w-]+/g, '');
}

function filterTasks() {
    const priority = document.getElementById('priorityFilter').value.toLowerCase();
    const assignedTo = document.getElementById('assignedToFilter').value.toLowerCase();
    const status = document.getElementById('statusFilter')?.value || '';
    const rows = document.querySelectorAll('tbody tr');

    rows.forEach(row => {
        const tds = row.querySelectorAll('td');
        if (tds.length < 6) return; // skip if row doesn't have enough data cells

        const priorityText = tds[2].textContent.toLowerCase();
        const assignedToText = tds[3].textContent.toLowerCase();
        const statusText = slugify(tds[4]?.textContent);;

        const matches =
            (priority === '' || priorityText.includes(priority)) &&
            (assignedTo === '' || assignedToText.includes(assignedTo)) &&
            (status === '' || statusText.includes(status));

        row.style.display = matches ? '' : 'none';
    });
}
</script>


  {% endblock %}
