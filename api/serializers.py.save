from rest_framework import serializers
from django.contrib.auth import authenticate
from django.utils.translation import gettext_lazy as _
from HRM.models import Department
from dashboard.models import CustomUser
from employees.models import Employee
from STK.models import STKTake
from rest_framework import serializers
from manage_tasks.models import ServiceCharge

class ServiceChargeSerializer(serializers.ModelSerializer):
    total_price = serializers.SerializerMethodField()

    class Meta:
        model = ServiceCharge
        fields = ['id', 'name', 'charge', 'tax_percent', 'total_price']

    def get_total_price(self, obj):
        return obj.total_with_tax()

    def get_service_charges(self, obj):
        charges = ServiceCharge.objects.all()
        return ServiceChargeSerializer(charges, many=True).data
class TechnicianLoginSerializer(serializers.Serializer):
    username = serializers.CharField()
    password = serializers.CharField(write_only=True)

    def validate(self, attrs):
        username = attrs.get('username')
        password = attrs.get('password')

        if username and password:
            user = authenticate(request=self.context.get('request'), username=username, password=password)

            if not user:
                raise serializers.ValidationError(_('Invalid login credentials.'), code='authorization')

            if not user.department or user.department.department_name.lower() != 'technician':
                raise serializers.ValidationError(_('You are not authorized to use the app.'), code='authorization')

            attrs['user'] = user
            return attrs

        raise serializers.ValidationError(_('Must include "username" and "password".'), code='authorization')



# api/serializers.py
from manage_tasks.models import TaskBilling

class TaskBillingSerializer(serializers.ModelSerializer):
    class Meta:
        model = TaskBilling
        fields = ['task', 'tools_total', 'service_total', 'final_total']
        read_only_fields = ['final_total',']

    def create(self, validated_data):
        tools_total = validated_data['tools_total']
        service_total = validated_data['service_total']
        final_total = tools_total + service_total
        validated_data['final_total'] = final_total
        return super().create(validated_data)

from rest_framework import serializers
from manage_tasks.models import Task

class TaskListSerializer(serializers.ModelSerializer):
    customer_name = serializers.CharField(source='customer.customer_name', read_only=True)
    customer_phone = serializers.SerializerMethodField()
    service = ServiceChargeSerializer(read_only=True)
    class Meta:
        model = Task
        fields = [
            'sno', 'task_detail', 'priority', 'location',
            'date', 'status',
            'customer_name', 'customer_phone','service',
        ]
        depth = 1  # So project and task_group names are included

    def get_customer_phone(self, obj):
        if obj.customer:
            return f"{obj.customer.country_code}-{obj.customer.phone}"
        return None



class TaskStatusUpdateSerializer(serializers.ModelSerializer):
    class Meta:
        model = Task
        fields = ['status']

    def validate_status(self, value):
        if value not in ['accepted', 'rejected', 'waiting']:
            raise serializers.ValidationError("Invalid status.")
        return value

class ProfileUpdateSerializer(serializers.Serializer):
    first_name = serializers.CharField(required=False)
    last_name = serializers.CharField(required=False)
    phone = serializers.CharField(required=False)
    address = serializers.CharField(required=False)
    photo = serializers.ImageField(required=False)

    def update(self, instance, validated_data):
        # Update CustomUser fields
        instance.first_name = validated_data.get('first_name', instance.first_name)
        instance.last_name = validated_data.get('last_name', instance.last_name)
        instance.save()

        # Update Employee fields
        try:
            employee = Employee.objects.get(email=instance.email)
        except Employee.DoesNotExist:
            employee = None

        if employee:
            employee.phone = validated_data.get('phone', employee.phone)
            employee.address = validated_data.get('address', employee.address)
            if 'photo' in validated_data:
                employee.photo = validated_data['photo']
            employee.save()

        return instance


from rest_framework import serializers
from STK.models import STKTake

class STKTakeSerializer(serializers.ModelSerializer):
    item_name = serializers.CharField(source='item.item_name', read_only=True)
    unit = serializers.CharField(source='item.unit.unit_name', read_only=True)
    category = serializers.CharField(source='item.category.category_name', read_only=True)
    transaction_type = serializers.StringRelatedField()
    class Meta:
        model = STKTake
        fields = ['id', 'item_name', 'category', 'unit', 'quantity', 'price', 'note', 'date', 'transaction_type']

class STKTakeCreateSerializer(serializers.ModelSerializer):
    transaction_type = serializers.SlugRelatedField(read_only=True, slug_field='name')
    class Meta:
        model = STKTake
        fields = ['item', 'quantity', 'price', 'note','transaction_type']


