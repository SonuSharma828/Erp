{% extends 'base.html' %}
{% block title %}Add Project{% endblock %}

{% block navcontent %}
{% if request.user.is_authenticated %}
  {% if request.user.is_superuser %}
    {% include 'dashboard/admin.html' %}
  {% elif request.user.department %}
    {% if request.user.department.department_name|lower == "hr" %}
      {% include 'dashboard/hr.html' %}
    {% endif %}
  {% endif %}
{% endif %}
{% endblock %}

{% block content %}
<div class="container mx-auto p-6">
  <h1 class="text-3xl font-semibold mb-4">Add New Project</h1>

  <form action="{% url 'project:add_project' %}" method="POST" class="bg-white p-6 rounded-md shadow-md">
    {% csrf_token %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

      <!-- Project Name
      <div>
        <label for="project_name" class="block text-sm font-semibold text-gray-700">Project Name</label>
        <input type="text" id="project_name" name="name" class="w-full mt-2 px-4 py-2 border rounded-md" required>
      </div>-->

      <div>
        <label for="{{ form.name.id_for_label }}" class="block text-sm font-semibold text-gray-700">Project Type</label>
        {{ form.name }}
        {% if form.name.errors %}
          <p class="text-red-500 text-sm">{{ form.name.errors.0 }}</p>
        {% endif %}
      </div>
      <!-- Client Dropdown 
      <div>
        <label for="client" class="block text-sm font-semibold text-gray-700">Client</label>
        <select name="client" id="client" class="w-full mt-2 px-4 py-2 border rounded-md" required>
          <option value="" disabled selected>Select Client</option>
          {% for customer in customers %}
            <option value="{{ customer.id }}">{{ customer.customer_name }}</option>
          {% endfor %}
        </select>
      </div>-->

<div>
  <label for="client" class="block text-sm font-semibold text-gray-700">Client</label>
  <input type="text" id="client-search" placeholder="Search client..." class="w-full mt-2 px-4 py-2 border rounded-md" />

  <select id="client-dropdown" name="client" class="w-full mt-2 px-4 py-2 border rounded-md" required>
    <option disabled selected>Loading clients...</option>
  </select>

  <div class="flex justify-between mt-2">
    <button type="button" id="prev-page" class="text-blue-600">⬅️ Prev</button>
    <button type="button" id="next-page" class="text-blue-600">Next ➡️</button>
  </div>
</div>

      <!-- Description -->
      <div class="md:col-span-2">
        <label for="description" class="block text-sm font-semibold text-gray-700">Description</label>
        <textarea id="description" name="desc" rows="4" class="w-full mt-2 px-4 py-2 border rounded-md" required></textarea>
      </div>
      <div class="md:col-span-2">
        <label for="description" class="block text-sm font-semibold text-gray-700">Address</label>
        <textarea id="description" name="address" rows="4" class="w-full mt-2 px-4 py-2 border rounded-md" required></textarea>
      </div>
      <!-- Start Date -->
      <div>
        <label for="start_date" class="block text-sm font-semibold text-gray-700">Start Date</label>
        <input type="date" id="start_date" name="startdate" class="w-full mt-2 px-4 py-2 border rounded-md" required>
      </div>

      <!-- Deadline -->
      <div>
        <label for="end_date" class="block text-sm font-semibold text-gray-700">End Date</label>
        <input type="date" id="end_date" name="deadline" class="w-full mt-2 px-4 py-2 border rounded-md" required>
      </div>

      <!-- Status (from form) -->
      <div>
        <label for="{{ form.status.id_for_label }}" class="block text-sm font-semibold text-gray-700">Status</label>
        {{ form.status }}
        {% if form.status.errors %}
          <p class="text-red-500 text-sm">{{ form.status.errors.0 }}</p>
        {% endif %}
      </div>
<!-- GST Number Field -->
<div>
  <label for="gst_number" class="block text-sm font-semibold text-gray-700">GST Number</label>
  <input type="text" id="gst_number" name="gst_number" class="w-full mt-2 px-4 py-2 border rounded-md" placeholder="Enter GST Number">
</div>

      <!-- Contact Person --
      <div class="md:col-span-2">
        <label class="block text-sm font-semibold text-gray-700">Contact Person</label>
        <div class="flex gap-4 mt-2">
          <button type="button" onclick="useClientAsContact()" class="px-3 py-1 bg-blue-500 text-white rounded">Use Client</button>
          <button type="button" onclick="showManualContactForm()" class="px-3 py-1 bg-gray-500 text-white rounded">Add Manually</button>
        </div>
        <div id="manual-contact" class="hidden mt-4">
          <input type="text" name="contact_person_name" placeholder="Name" class="w-full mb-2 px-4 py-2 border rounded-md">
          <input type="text" name="contact_person_phone" placeholder="Phone" class="w-full px-4 py-2 border rounded-md">
        </div>
<div id="client-dropdown" class="hidden mt-4">
  <label for="client" class="block text-sm font-semibold text-gray-700">Client</label>
  <select name="contact_person" id="client" class="w-full mt-2 px-4 py-2 border rounded-md">
    <option value="" disabled selected>Select Client</option>
    {% for customer in customers %}
      <option value="{{ customer.id }}">{{ customer.customer_name }}</option>
    {% endfor %}
  </select>
</div>
      </div>-->

<!-- Contact Person Section -->
<div class="md:col-span-2">
  <label class="block text-sm font-semibold text-gray-700">Contact Person</label>
  <div class="flex gap-4 mt-2">
    <button type="button" onclick="useClientAsContact()" class="px-3 py-1 bg-blue-500 text-white rounded">Use Client</button>
    <button type="button" onclick="showManualContactForm()" class="px-3 py-1 bg-gray-500 text-white rounded">Add Manually</button>
  </div>

  <!-- Manual Form -->
  <div id="manual-contact" class="hidden mt-4">
    <input type="text" name="contact_person_name" placeholder="Name" class="w-full mb-2 px-4 py-2 border rounded-md">
    <input type="text" name="contact_person_phone" placeholder="Phone" class="w-full px-4 py-2 border rounded-md">
  </div>

  <!-- Searchable Dropdown -->
  <div id="contact-person-dropdown" class="hidden mt-4">
    <label for="contact_person_search" class="block text-sm font-semibold text-gray-700">Search Client</label>
    <input type="text" id="contact_person_search" class="w-full mt-2 px-4 py-2 border rounded-md" placeholder="Search client...">

    <select name="contact_person" id="contact_person_select" class="w-full mt-2 px-4 py-2 border rounded-md">
      <option disabled selected>Loading...</option>
    </select>

    <div class="flex justify-between mt-2">
      <button type="button" id="contact_prev" class="text-blue-600">⬅️ Prev</button>
      <button type="button" id="contact_next" class="text-blue-600">Next ➡️</button>
    </div>
  </div>
</div>


      <!-- Budget Section -->
      <div>
        <label for="equipment_budget" class="block text-sm font-semibold text-gray-700">Equipment Budget</label>
        <input type="number" id="equipment_budget" name="budget_equipment" class="w-full mt-2 px-4 py-2 border rounded-md" step="0.01" required>
      </div>

      <div>
        <label for="execution_budget" class="block text-sm font-semibold text-gray-700">Execution Budget</label>
        <input type="number" id="execution_budget" name="budget_execution" class="w-full mt-2 px-4 py-2 border rounded-md" step="0.01" required>
      </div>

    </div>

    <!-- Submit Button -->
    <div class="mt-6 flex justify-end">
      <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save Project</button>
      <a href="{% url 'project:project' %}" class="px-4 py-2 text-blue-500 rounded ml-2">Back</a>
    </div>
  </form>
</div>

<script>
let contactDataLoaded = false;

function fetchDropdownData(inputId, selectId, prevBtnId, nextBtnId, url) {
  let currentPage = 1;
  let query = "";

  const input = document.getElementById(inputId);
  const select = document.getElementById(selectId);
  const prevBtn = document.getElementById(prevBtnId);
  const nextBtn = document.getElementById(nextBtnId);

  function loadData() {
    fetch(`${url}?page=${currentPage}&q=${encodeURIComponent(query)}`)
      .then(response => response.json())
      .then(data => {
        select.innerHTML = "";
        data.results.forEach(item => {
          const option = document.createElement("option");
          option.value = item.id;
          option.textContent = item.name;
          select.appendChild(option);
        });

        // ✅ Prevent error if button doesn't exist
        if (prevBtn) prevBtn.disabled = !data.has_prev;
        if (nextBtn) nextBtn.disabled = !data.has_next;
      });
  }

  if (input) {
    input.addEventListener("input", () => {
      query = input.value;
      currentPage = 1;
      loadData();
    });
  }

  if (prevBtn) {
    prevBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        loadData();
      }
    });
  }

  if (nextBtn) {
    nextBtn.addEventListener("click", () => {
      currentPage++;
      loadData();
    });
  }

  // Initial load
  loadData();
}

// ✅ Always load client dropdown at page load
fetchDropdownData(
  'client-search',
  'client-dropdown',
  'client-prev',
  'client-next',
  "{% url 'project:ajax_customers' %}"
);

// ✅ Contact Person: load only when button clicked
function useClientAsContact() {
  document.getElementById('manual-contact').classList.add('hidden');
  document.getElementById('contact-person-dropdown').classList.remove('hidden');

  if (!contactDataLoaded) {
    fetchDropdownData(
      'contact_person_search',
      'contact_person_select',
      'contact_prev',
      'contact_next',
      "{% url 'project:ajax_customers' %}"
    );
    contactDataLoaded = true;
  }
}

function showManualContactForm() {
  document.getElementById('contact-person-dropdown').classList.add('hidden');
  document.getElementById('manual-contact').classList.remove('hidden');
}
</script>


{% endblock %}
