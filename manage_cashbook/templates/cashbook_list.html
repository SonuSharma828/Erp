{% extends 'base.html' %}
{% block title %}CashBook{% endblock %}
{% load custom_filters %}
{% block navcontent %}
  {% if request.user.is_authenticated %}
    {% if request.user.is_superuser %}
      {% include 'dashboard/admin.html' %}
    {% elif request.user.department %}
      {% if request.user.department.department_name|strip_lower == "finance" %}
        {% include 'dashboard/finance.html' %}
      {% endif %}
    {% endif %}
  {% endif %}
{% endblock %}

{% block content %}
<div class="py-8">
  <div class="bg-white p-6 rounded shadow">
    <h1 class="text-3xl font-bold mb-4">Cashbook Entries</h1>

    <!-- Summary Cards -->
    <div class="flex space-x-4 mb-6">
      <div class="bg-green-200 p-4 rounded w-1/2">
        <h2 class="text-xl font-semibold">Total In</h2>
        <p class="text-2xl font-bold text-green-800">₹{{ amount_in }}</p>
      </div>
      <div class="bg-red-200 p-4 rounded w-1/2">
        <h2 class="text-xl font-semibold">Total Out</h2>
        <p class="text-2xl font-bold text-red-800">₹{{ amount_out }}</p>
      </div>
    </div>

    <!-- Filters and Add Button -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
      <div class="flex flex-wrap gap-3">
        <input type="text" id="searchInput" placeholder="Search..." class="px-3 py-2 border border-gray-300 rounded" />

        <select id="segmentFilter" class="px-3 py-2 border border-gray-300 rounded">
          <option value="">All Segments</option>
          {% for seg in segments %}
            <option value="{{ seg.name }}">{{ seg.name }}</option>
          {% endfor %}
        </select>

        <select id="typeFilter" class="px-3 py-2 border border-gray-300 rounded">
          <option value="">All Types</option>
          {% for t in types %}
            <option value="{{ t.name }}">{{ t.name }}</option>
          {% endfor %}
        </select>
      </div>

      <a href="{% url 'add_cashbook_entry' %}" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 whitespace-nowrap">+ Add New Entry</a>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto bg-white shadow-md rounded-lg">
      <table class="min-w-full text-left border border-gray-200 text-sm" id="cashbookTable">
        <thead class="bg-gray-100 text-gray-700 uppercase">
          <tr>
            <th class="border p-2 whitespace-nowrap">S.No</th>
            <th class="border p-2 whitespace-nowrap">Date</th>
            <th class="border p-2 whitespace-nowrap">Mode</th>
            <th class="border p-2 whitespace-nowrap">Segment</th>
            <th class="border p-2 whitespace-nowrap">Type</th>
            <th class="border p-2 whitespace-nowrap">Amount</th>
            <th class="border p-2 whitespace-nowrap">Description</th>
            <th class="border p-2 whitespace-nowrap">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in page_obj %}
          <tr class="entry-row">
            <td class="border p-2 whitespace-nowrap">{{ forloop.counter0|add:page_obj.start_index }}</td>
            <td class="border p-2 whitespace-nowrap">{{ entry.entry_date }}</td>
            <td class="border p-2 whitespace-nowrap">{{ entry.payment_mode }}</td>
            <td class="border p-2 whitespace-nowrap">{{ entry.segment }}</td>
            <td class="border p-2 whitespace-nowrap">{{ entry.entry_type }}</td>
            <td class="border p-2 whitespace-nowrap">₹{{ entry.amount }}</td>
            <td class="border p-2 whitespace-nowrap">{{ entry.description }}</td>
            <td class="border p-2 space-x-2 whitespace-nowrap">
              <a href="{% url 'edit_cashbook_entry' entry.id %}" class="inline-block bg-blue-500 text-white text-sm px-3 py-1 rounded hover:bg-blue-600">Edit</a>
              <a href="{% url 'delete_cashbook_entry' entry.id %}" class="inline-block bg-red-500 text-white text-sm px-3 py-1 rounded hover:bg-red-600" onclick="return confirm('Are you sure you want to delete this entry?')">Delete</a>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="8" class="border p-2 text-center">No entries found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
{% if page_obj.paginator.num_pages > 1 %}
<div class="mt-4 flex justify-center space-x-2">
  {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">&laquo; Prev</a>
  {% endif %}

  <span class="px-4 py-1 bg-blue-600 text-white rounded">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

  {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Next &raquo;</a>
  {% endif %}
</div>
{% endif %}

  </div>
</div>

<!-- ✅ Filter & Search Script -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const rows = document.querySelectorAll('.entry-row');
    const searchInput = document.getElementById('searchInput');
    const segmentFilter = document.getElementById('segmentFilter');
    const typeFilter = document.getElementById('typeFilter');

    function filterRows() {
      const search = searchInput.value.toLowerCase();
      const segment = segmentFilter.value.toLowerCase();
      const type = typeFilter.value.toLowerCase();

      rows.forEach(row => {
        const rowText = row.innerText.toLowerCase();
        const segmentText = row.children[3].innerText.toLowerCase();
        const typeText = row.children[4].innerText.toLowerCase();

        const matchesSearch = rowText.includes(search);
        const matchesSegment = !segment || segmentText === segment;
        const matchesType = !type || typeText === type;

        row.style.display = matchesSearch && matchesSegment && matchesType ? '' : 'none';
      });
    }

    searchInput.addEventListener('input', filterRows);
    segmentFilter.addEventListener('change', filterRows);
    typeFilter.addEventListener('change', filterRows);
  });
</script>
{% endblock %}

