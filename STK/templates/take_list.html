{% extends 'base.html' %}
{% load static %}
{% block navcontent %}
  {% if request.user.is_authenticated %}
    {% if request.user.is_superuser %}
      {% include 'dashboard/admin.html' %}
    {% elif request.user.department %}
      {% if request.user.department.department_name|lower == "inventory" %}
        {% include 'dashboard/inventory.html' %}
      {% endif %}
    {% endif %}
  {% endif %}
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto p-6">
    <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4 gap-4">
        <h1 class="text-2xl font-bold">Stock Take</h1>
        <a href="{% url 'take_add' %}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Add New</a>
    </div>

    <!-- 🔍 Filters + Search -->
    <div class="flex flex-col md:flex-row gap-4 mb-6">
        <input
          id="searchInput"
          type="text"
          placeholder="Search..."
          class="w-full md:w-1/3 px-4 py-2 border rounded"
        />

        


    <select id="typeFilter" class="w-full md:w-1/4 px-4 py-2 border rounded">
        <option value="">All Types</option>
        {% for types in type %}
        <option value="{{ types.name|lower }}">{{ types.name }}</option>
        {% endfor %}
    </select>



    <select id="userFilter" class="w-full md:w-1/4 px-4 py-2 border rounded">
        <option value="">Issued To</option>
        {% for user in users %}
        <option value="{{ user.username|default:user.username|lower }}">{{ user.username|default:user.username }}</option>
        {% endfor %}
    </select>


    </div>

    <table class="min-w-full bg-white border border-gray-300 rounded-lg shadow" id="takeTable">
        <thead>
            <tr class="bg-gray-100 text-left">
                 <th class="py-2 px-4">Sno</th>
                <th class="py-2 px-4">Stock</th>
                <th class="py-2 px-4">Quantity</th>
                <th class="py-2 px-4">Type</th>
                <th class="py-2 px-4">Issued To</th>
                <th class="py-2 px-4">Price</th>
                <th class="py-2 px-4">Date</th>
                <th class="py-2 px-4">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for take in page_obj %}
            <tr class="border-t hover:bg-gray-50 take-row">
                <td class="py-2 px-4">{{ forloop.counter0|add:page_obj.start_index}}</td>
                <td class="py-2 px-4">{{ take.item|title }}</td>
                <td class="py-2 px-4">{{ take.quantity }}</td>
                <td class="py-2 px-4">{{ take.transaction_type }}</td>
                <td class="py-2 px-4">{{ take.taken_by.username }}</td>
                <td class="py-2 px-4">{{ take.price }}</td>
                <td class="py-2 px-4">{{ take.date }}</td>
                <td class="py-2 px-4">
                    <a href="{% url 'take_edit' take.id %}" class="inline-block bg-blue-500 text-white text-sm px-3 py-1 rounded hover:bg-blue-600">Edit</a>
                    <a href="{% url 'take_delete' take.id %}" onclick="return confirm('Are you sure you want to delete this record?')" class="inline-block bg-red-500 text-white text-sm px-3 py-1 rounded hover:bg-red-600">Delete</a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center py-4 text-gray-500">No records found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% if page_obj.paginator.count > 10 %}
<div class="mt-4 flex justify-center space-x-2">
  {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">&laquo; Prev</a>
  {% endif %}

  <span class="px-4 py-1 bg-blue-600 text-white rounded">{{ page_obj.number }}</span>

  {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Next &raquo;</a>
  {% endif %}
</div>
{% endif %}

</div>

<!-- 🔁 Client-Side Filtering Script -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("searchInput");
    const typeFilter = document.getElementById("typeFilter");
    const userFilter = document.getElementById("userFilter");
    const rows = document.querySelectorAll(".take-row");

    function filterRows() {
      const searchValue = searchInput.value.toLowerCase();
      const typeValue = typeFilter.value.toLowerCase();
      const userValue = userFilter.value.toLowerCase();

      rows.forEach((row) => {
        const rowText = row.innerText.toLowerCase();
        const rowType = row.children[2].innerText.toLowerCase();
        const rowUser = row.children[3].innerText.toLowerCase();

        const matchesSearch = rowText.includes(searchValue);
        const matchesType = !typeValue || rowType === typeValue;
        const matchesUser = !userValue || rowUser === userValue;

        row.style.display = matchesSearch && matchesType && matchesUser ? "" : "none";
      });
    }

    searchInput.addEventListener("input", filterRows);
    typeFilter.addEventListener("change", filterRows);
    userFilter.addEventListener("change", filterRows);
  });
</script>
{% endblock %}

